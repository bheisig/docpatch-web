var DocPatch=function(options){"use strict";this.prefix=options.prefix,this.repoDir=options.repoDir,this.dateFormat=options.dateFormat,this.meta={},this.formats=[{title:"DocBook",ext:"db"},{title:"eBook (EPUB)",ext:"epub",emphasize:!0},{title:"HTML",ext:"html",emphasize:!0},{title:"JSON",ext:"json"},{title:"Klartext (txt)",ext:"txt",emphasize:!0},{title:"LaTeX",ext:"tex"},{title:"Man Page",ext:"gz"},{title:"Markdown",ext:"md"},{title:"Mediawiki",ext:"wiki"},{title:"Open Document",ext:"xml"},{title:"Open Document Format (ODT)",ext:"odt"},{title:"org mode (Emacs)",ext:"org"},{title:"PDF",ext:"pdf",emphasize:!0},{title:"RST",ext:"text"},{title:"RTF",ext:"rtf"},{title:"Textile",ext:"textile"}],this.previousRevisionID=0,this.i18n={dataTables:{sProcessing:"Bitte warten ...",sLengthMenu:"_MENU_ Einträge anzeigen",sZeroRecords:"Keine Einträge vorhanden",sInfo:"_START_ bis _END_ von _TOTAL_ Einträgen",sInfoEmpty:"0 bis 0 von 0 Einträgen",sInfoFiltered:"(gefiltert von _MAX_  Einträgen)",sInfoPostFix:"",sSearch:"Suchen",sUrl:"",oPaginate:{sFirst:"Erster",sPrevious:"Zurück",sNext:"Nächster",sLast:"Letzter"}}};var that=this;this.calculateAge=function(dateString){var today=new Date,birthDate=new Date(dateString),age=today.getFullYear()-birthDate.getFullYear(),m=today.getMonth()-birthDate.getMonth();return(0>m||0===m&&today.getDate()<birthDate.getDate())&&(age-=1),age},this.drawChangesPerYear=function(){var range,chart,changes={},ctx=$("#changesPerYear").get(0).getContext("2d");range=_.range(Number($.datepicker.formatDate("yy",new Date(_.first(that.meta.revisions).announced))),Number($.datepicker.formatDate("yy",new Date(_.last(that.meta.revisions).announced)))+1),$.each(range,function(){changes[this.valueOf()]=0}),$.each(that.meta.revisions,function(){var year=Number($.datepicker.formatDate("yy",new Date(this.announced)));changes[year]+=1}),chart=new Chart(ctx).Bar({labels:range,datasets:[{data:$.map(changes,function(key){return key})}]})},this.drawChangesPerPeriod=function(){var range,chart,changes={},ctx=$("#changesPerPeriod").get(0).getContext("2d");range=_.range(Number(that.meta.revisions[1].legislativeSession.id),Number(_.last(that.meta.revisions).legislativeSession.id)+1),$.each(range,function(){changes[this.valueOf()]=0}),$.each(that.meta.revisions,function(){if(this.legislativeSession){var year=Number(this.legislativeSession.id);changes[year]+=1}}),chart=new Chart(ctx).Bar({labels:range,datasets:[{data:$.map(changes,function(key){return key})}]})},this.drawResultOfTheVote=function(){var ctx,chart,calculateResult,revision=that.meta.revisions[Number($("#revisionStats").val())],yes=revision.votes&&revision.votes.yes,no=revision.votes&&revision.votes.no,abstentions=revision.votes&&revision.votes.abstentions,notVoted=revision.votes&&revision.votes.notVoted,invalid=revision.votes&&revision.votes.invalid,sum=0,result=[];return $("#resultOfTheVoteAlert").removeClass("in"),$("#resultOfTheVote").hide(),$("#resultOfTheVoteList").hide(),revision.votes?(calculateResult=function(number,color){return number?(result.push({value:number,color:color}),sum+=number):isNaN(number)&&(number="k.&nbsp;A."),number},yes=calculateResult(yes,"#468847"),no=calculateResult(no,"#B94A48"),abstentions=calculateResult(abstentions,"#F89406"),notVoted=calculateResult(notVoted,"#3A87AD"),invalid=calculateResult(invalid,"#999999"),ctx=$("#resultOfTheVote").fadeIn().get(0).getContext("2d"),chart=new Chart(ctx).Pie(result),$("#resultOfTheVoteList").html('<li><span class="badge badge-success">'+yes+"</span> ja</li>"+'<li><span class="badge badge-important">'+no+"</span> nein</li>"+'<li><span class="badge badge-warning">'+abstentions+"</span> enthalten</li>"+'<li><span class="badge badge-info">'+notVoted+"</span> nicht abgestimmt</li>"+'<li><span class="badge">'+invalid+"</span> ungültig</li>"+"<li><strong>"+sum+"</strong> insgesamt</li>").fadeIn(),void 0):($("#resultOfTheVoteAlert").addClass("in"),void 0)},this.compareRevisions=function(firstRevision,secondRevision){var firstRevisionID,secondRevisionID,d,comparisionOutput,dmp=new diff_match_patch,firstText="",secondText="",firstRevisionTitle="ohne Titel",secondRevisionTitle="ohne Titel",firstRevisionAnnounced="ohne Datum",secondRevisionAnnounced="ohne Datum";-1!==firstRevision&&(firstRevisionID=that.createRevisionID(that.meta.revisions[firstRevision]),firstText=that.fetchOrCache(firstRevisionID,that.repoDir+"/out/"+that.prefix+firstRevisionID+".txt","text",!1),firstRevisionTitle=that.meta.revisions[firstRevision].title,firstRevisionAnnounced=$.datepicker.formatDate(that.dateFormat,new Date(that.meta.revisions[firstRevision].announced))),-1!==secondRevision&&(secondRevisionID=that.createRevisionID(that.meta.revisions[secondRevision]),secondText=that.fetchOrCache(secondRevisionID,that.repoDir+"/out/"+that.prefix+secondRevisionID+".txt","text",!1),secondRevisionTitle=that.meta.revisions[secondRevision].title,secondRevisionAnnounced=$.datepicker.formatDate(that.dateFormat,new Date(that.meta.revisions[secondRevision].announced))),dmp.Diff_Timeout=1,dmp.Diff_EditCost=4,d=dmp.diff_main(firstText,secondText),comparisionOutput=dmp.diff_prettyHtml(d),$("#compareModalLabel").html('Fassung &bdquo;<span class="highlightfirstrevision">'+firstRevisionTitle+"</span>&rdquo; ("+firstRevisionAnnounced+') verglichen mit Fassung &bdquo;<span class="highlightsecondrevision">'+secondRevisionTitle+"</span>&rdquo; ("+secondRevisionAnnounced+")"),$("#compareModal .modal-body").html(comparisionOutput),$("#compareModal").modal()},this.createRevisionID=function(revision){return revision.id+"_"+revision.announced},this.fetchOrCache=function(key,uri,type,async){var value;return localStorage?(value=localStorage.getItem(key),value?"json"===type&&(value=JSON.parse(value)):$.ajax({url:uri,dataType:type,async:async}).done(function(response){value=response,"json"===type&&(response=JSON.stringify(response)),localStorage.setItem(key,response)})):$.ajax({url:uri,dataType:type,async:async}).done(function(response){return response}),value},this.collectMetaData=function(revision){var year,passed,date,announced,effectiveSince,articles,signedOffBy,sources,votes,collectedMetaData=[];return revision.passed&&(passed=new Date(revision.passed),year=$.datepicker.formatDate("yy",passed),collectedMetaData.push({key:"Verabschiedet",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,passed)+"</a>"})),revision.date&&(date=new Date(revision.date),year=$.datepicker.formatDate("yy",date),collectedMetaData.push({key:"Gesetz vom",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,date)+"</a>"})),revision.announced&&(announced=new Date(revision.announced),year=$.datepicker.formatDate("yy",announced),collectedMetaData.push({key:"Angekündigt",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,announced)+"</a>"})),revision.effectiveSince&&(effectiveSince=new Date(revision.effectiveSince),year=$.datepicker.formatDate("yy",effectiveSince),collectedMetaData.push({key:"Inkraftgetreten am",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,effectiveSince)+"</a>"})),revision.articles&&(articles=[],revision.articles.created&&articles.push("Artikel "+revision.articles.created.join(", ")+" hinzugefügt"),revision.articles.updated&&articles.push("Artikel "+revision.articles.updated.join(", ")+" verändert"),revision.articles.deleted&&articles.push("Artikel "+revision.articles.deleted.join(", ")+" entfernt"),collectedMetaData.push({key:"Änderungen",value:'<a href="javascript:docpatch.compareRevisions('+that.previousRevisionID+", "+revision.id+')" title="">'+articles.join("; ")+"</a>"})),revision.signedOffBy&&(signedOffBy=[],$.each(revision.signedOffBy,function(){signedOffBy.push((this.uri?'<a href="'+this.uri+'" title="'+this.uri+'">'+this.name+"</a>":this.name)+" ("+this.role+")")}),collectedMetaData.push({key:"Unterzeichner",value:signedOffBy.join(", ")})),revision.sources&&(sources=[],$.each(revision.sources,function(){sources.push(this.title+", Seite "+this.pages)}),collectedMetaData.push({key:"Quellen",value:sources.join(", ")})),revision.legislativeSession&&collectedMetaData.push({key:'<a href="http://de.wikipedia.org/wiki/Deutscher_Bundestag" title="Deutscher Bundestag (Wikipedia)">Legislaturperiode</a>',value:'<a href="'+revision.legislativeSession.uri+'" title="'+revision.legislativeSession.id+'. Bundestag (Wikipedia)">'+revision.legislativeSession.id+". Bundestag</a>"}),revision.votes&&(votes=[],void 0!==revision.votes.yes&&votes.push(revision.votes.yes+" Ja-Stimme"+(1!==revision.votes.yes?"n":"")),void 0!==revision.votes.no&&votes.push(revision.votes.no+" Nein-Stimme"+(1!==revision.votes.no?"n":"")),void 0!==revision.votes.abstentions&&votes.push(revision.votes.abstentions+" Enthaltung"+(1!==revision.votes.abstentions?"en":"")),void 0!==revision.votes.notVoted&&votes.push(revision.votes.notVoted+" nicht abgestimmt"),void 0!==revision.votes.invalid&&votes.push(revision.votes.invalid+" ungültig"),collectedMetaData.push({key:"Abstimmung",value:votes.join(", ")})),revision.initiativeOf&&collectedMetaData.push({key:"Initiative von",value:revision.initiativeOf}),that.previousRevisionID=revision.id,collectedMetaData},this.formatMeta=function(revision){var formatted="<table>",collectedMetaData=that.collectMetaData(revision);return $.each(collectedMetaData,function(){formatted+="<tr><th>"+this.key+":</th><td>"+this.value+"</td></tr>"}),formatted+="</table>"},this.drawActorsTable=function(){var i,roles,actors={},entities=[];if(that.actorsTableDrawn||(that.actorsTableDrawn=0),1!==that.actorsTableDrawn){$.each(that.meta.revisions,function(){this.signedOffBy&&$.each(this.signedOffBy,function(){actors[this.uri]?(actors[this.uri].number+=1,actors[this.uri].roles.push(this.role)):(actors[this.uri]={},actors[this.uri].name=this.name,actors[this.uri].roles=[this.role],actors[this.uri].number=1,actors[this.uri].uri=this.uri)})});for(i in actors)roles=_.uniq(actors[i].roles),entities.push(['<a href="'+actors[i].uri+'" title="'+actors[i].uri+'">'+actors[i].name+"</a>",roles.join(", "),actors[i].number]);entities.slice(-1),$("#actorsTable").dataTable({aaData:entities,aoColumns:[{sTitle:"Name"},{sTitle:"Rollen"},{sTitle:"Unterschriften",sClass:"right"}],oLanguage:that.i18n.dataTables}),that.actorsTableDrawn=1}},this.drawArticlesTable=function(){var articles={},entities=[];that.articlesTableDrawn||(that.articlesTableDrawn=0),1!==that.articlesTableDrawn&&($.each(that.meta.revisions,function(){var version=this.id+1;this.articles&&$.each(this.articles,function(key,value){$.each(value,function(){switch(articles[this]||(articles[this]={},articles[this].numberOfChanges=0,articles[this].history={}),articles[this].numberOfChanges+=1,key){case"created":articles[this].history.created=version;break;case"updated":articles[this].history.updated||(articles[this].history.updated=[]),articles[this].history.updated.push(version);break;case"deleted":articles[this].history.deleted=version}})})}),$.each(articles,function(key,value){var history=[];value.history.created&&history.push("hinzugefügt in Fassung "+value.history.created),value.history.updated&&(1===value.history.updated.length?history.push("geändert in Fassung "+value.history.updated.join(", ")):history.push("geändert in Fassungen "+value.history.updated.join(", "))),value.history.deleted&&history.push("aufgehoben in Fassung "+value.history.deleted),entities.push([key,value.numberOfChanges,history.join(", ")])}),$("#articlesTable").dataTable({aaData:entities,aoColumns:[{sTitle:"Artikelnummer",sType:"numeric"},{sTitle:"Anzahl Änderungen",sClass:"right"},{sTitle:"Historie"}],oLanguage:that.i18n.dataTables}),that.articlesTableDrawn=1)},this.drawWordCloud=function(){var blackList,match,word,text,cloudWidth=979,cloudHeight=600,minOccurrence=7,fill=d3.scale.category20(),words=[],lastRevisionID=that.createRevisionID(that.latest),progress=0,wordList={},regExp=new XRegExp("[\\p{L}\\d\\-]*\\p{L}{2,}[\\p{L}\\d\\-]*","igm"),maxCount=0;if(that.wordCloudDrawn||(that.wordCloudDrawn=0),1!==that.wordCloudDrawn){for(text=that.fetchOrCache(lastRevisionID,that.repoDir+"/out/"+that.prefix+lastRevisionID+".txt","text",!1),blackList=that.fetchOrCache("germanST","Kickstrap/extras/blacklist/germanST.txt","text",!1).split("\n");match=regExp.exec(text);)word=match[0].toLowerCase(),_.contains(blackList,word)||word.length>=1&&/^x{0,3}i?v?i{0,3}$/i.exec(word)||(word in wordList?wordList[word]+=1:wordList[word]=1);words=_.reject(_.pairs(wordList),function(p){return minOccurrence>p[1]}),maxCount=0;for(var i=0;words.length>i;i++)words[i][1]>maxCount&&(maxCount=words[i][1]);$("#wordCloudLoading progress").attr("value",0).attr("max",words.length),$("#wordCloudLoading span").html(progress+"/"+words.length),d3.layout.cloud().size([cloudWidth,cloudHeight]).timeInterval(10).words(_.map(words,function(d){return{text:d[0],size:10+90*(d[1]/maxCount)}})).rotate(function(){return 90*~~(2*Math.random())}).font("Helvetica Neue").fontSize(function(d){return d.size}).padding(1).on("word",function(){progress+=1,$("#wordCloudLoading progress").attr("value",progress),$("#wordCloudLoading span").html(progress+"/"+words.length)}).on("end",function(words){d3.select("#wordCloudImage").insert("svg").attr("width",cloudWidth).attr("height",cloudHeight).append("g").attr("transform","translate(500,300)").selectAll("text").data(words).enter().append("text").style("font-size",function(d){return d.size+"px"}).style("font-family","Helvetica Neue").style("fill",function(d,i){return fill(i)}).attr("text-anchor","middle").attr("transform",function(d){return"translate("+[d.x,d.y]+")rotate("+d.rotate+")"}).text(function(d){return d.text}),$("#wordCloudLoading").fadeOut()}).start(),that.wordCloudDrawn=1}},this.meta=this.fetchOrCache("meta",this.repoDir+"/etc/meta.json","json",!1),$.each(this.meta.revisions.reverse(),function(){$("#revision, #firstrevision, #secondrevision, #revisionStats").append('<option value="'+this.id+'">'+(this.id+1)+". vom "+$.datepicker.formatDate(that.dateFormat,new Date(this.announced))+": "+this.title+"</option>")}),this.meta.revisions.reverse(),$.each(this.formats,function(){var emphasize="";this.emphasize&&(emphasize=' style="font-weight: bold;"'),$("#format").append('<option value="'+this.ext+'" title="'+this.ext+'"'+emphasize+">"+this.title+"</option>")}),$('#format option[value="pdf"]').attr("selected","selected"),$("#download").attr("href",this.repoDir+"/out/"+this.prefix+this.createRevisionID(this.meta.revisions[Number($("#revision").val())])+"."+$("#format").val()),$("#revision, #format").change(function(){var revisionID=that.createRevisionID(that.meta.revisions[Number($("#revision").val())]);$("#download").attr("href",that.repoDir+"/out/"+that.prefix+revisionID+"."+$("#format").val())}),this.latest=this.meta.revisions.slice(-1)[0],$("#latest").attr("href",this.repoDir+"/out/"+this.prefix+this.createRevisionID(this.latest)+".pdf"),$("#latest").attr("title",this.latest.id+1+'. Fassung "'+this.latest.title+'" vom '+$.datepicker.formatDate(this.dateFormat,new Date(this.latest.announced))+" im PDF-Format herunterladen"),this.timelineData={timeline:{headline:this.meta.title,type:"default",text:this.meta.subject,startDate:"1949,5,23",date:[]}},$.each(this.meta.revisions,function(){var announced=new Date(this.announced);that.timelineData.timeline.date.push({startDate:$.datepicker.formatDate("yy,m,d",announced),endDate:$.datepicker.formatDate("yy,m,d",announced),headline:this.title,text:that.formatMeta(this),asset:{media:"",credit:"",caption:""}})}),createStoryJS({type:"timeline",width:"100%",height:"600",source:this.timelineData,lang:"de",css:"Kickstrap/apps/timelinejs/css/timeline.css",js:"Kickstrap/apps/timelinejs/js/timeline-min.js"}),$("#comparerevisions").click(function(){var firstRevision=Number($("#firstrevision").val()),secondRevision=Number($("#secondrevision").val());that.compareRevisions(firstRevision,secondRevision)}),$('a[data-toggle="tab"]').on("shown",function(e){switch(e.target.href.split("#")[1]){case"legislativeSessions":that.drawChangesPerPeriod();break;case"years":that.drawChangesPerYear();break;case"actors":that.drawActorsTable();break;case"revisions":that.drawResultOfTheVote();break;case"articles":that.drawArticlesTable();break;case"wordcloud":that.drawWordCloud()}}),$("#revisionStats").change(function(){that.drawResultOfTheVote()}),this.numberOfChanges=this.meta.revisions.length-1,$("#numberOfChanges").html(this.numberOfChanges),this.age=this.calculateAge(this.meta.revisions[0].announced),$("#age").html(this.age),this.numberOfLegislativeSessions=this.latest.legislativeSession.id,$("#numberOfLegislativeSessions").html(this.numberOfLegislativeSessions),this.changesPerLegislativeSessions=this.numberOfChanges/this.numberOfLegislativeSessions,$("#numberOfChangesPerLegislativeSessions").html(Number(this.changesPerLegislativeSessions.toFixed(2))).attr("title",this.changesPerLegislativeSessions),this.changesPerYear=this.numberOfChanges/this.age,$("#numberOfChangesPerYear").html(Number(this.changesPerYear.toFixed(2))).attr("title",this.changesPerYear)};