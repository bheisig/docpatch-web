var DocPatch=function(options){"use strict";this.prefix=options.prefix;this.repoDir=options.repoDir;this.dateFormat=options.dateFormat;this.meta={};this.formats=[{title:"DocBook",ext:"db"},{title:"eBook (EPUB)",ext:"epub"},{title:"HTML",ext:"html"},{title:"JSON",ext:"json"},{title:"Klartext (txt)",ext:"txt"},{title:"LaTeX",ext:"tex"},{title:"Man Page",ext:"gz"},{title:"Markdown",ext:"md"},{title:"Mediawiki",ext:"wiki"},{title:"Open Document",ext:"xml"},{title:"Open Document Format (ODT)",ext:"odt"},{title:"org mode (Emacs)",ext:"org"},{title:"PDF",ext:"pdf"},{title:"RST",ext:"text"},{title:"RTF",ext:"rtf"},{title:"Textile",ext:"textile"}];this.previousRevisionID=0;var that=this;this.calculateAge=function(dateString){var today=new Date,birthDate=new Date(dateString),age=today.getFullYear()-birthDate.getFullYear(),m=today.getMonth()-birthDate.getMonth();if(m<0||m===0&&today.getDate()<birthDate.getDate()){age-=1}return age};this.drawChangesPerYear=function(){var range,changes={},ctx=$("#changesPerYear").get(0).getContext("2d"),chart;range=_.range(Number($.datepicker.formatDate("yy",new Date(_.first(that.meta.revisions).announced))),Number($.datepicker.formatDate("yy",new Date(_.last(that.meta.revisions).announced)))+1);$.each(range,function(){changes[this.valueOf()]=0});$.each(that.meta.revisions,function(){var year=Number($.datepicker.formatDate("yy",new Date(this.announced)));changes[year]+=1});chart=new Chart(ctx).Bar({labels:range,datasets:[{data:$.map(changes,function(key,value){return key})}]})};this.drawChangesPerPeriod=function(){var range,changes={},ctx=$("#changesPerPeriod").get(0).getContext("2d"),chart;range=_.range(Number(that.meta.revisions[1].legislativeSession.id),Number(_.last(that.meta.revisions).legislativeSession.id)+1);$.each(range,function(){changes[this.valueOf()]=0});$.each(that.meta.revisions,function(){if(this.legislativeSession){var year=Number(this.legislativeSession.id);changes[year]+=1}});chart=new Chart(ctx).Bar({labels:range,datasets:[{data:$.map(changes,function(key,value){return key})}]})};this.drawResultOfTheVote=function(){var revision=that.meta.revisions[Number($("#revisionStats").val())],yes=revision.votes&&revision.votes.yes||0,no=revision.votes&&revision.votes.no||0,abstentions=revision.votes&&revision.votes.abstentions||0,notVoted=revision.votes&&revision.votes.notVoted||0,invalid=revision.votes&&revision.votes.invalid||0,sum=yes+no+abstentions+notVoted+invalid,ctx,chart;$("#resultOfTheVoteAlert").removeClass("in");$("#resultOfTheVote").hide();$("#resultOfTheVoteList").hide();if(!revision.votes){$("#resultOfTheVoteAlert").addClass("in");return}ctx=$("#resultOfTheVote").fadeIn().get(0).getContext("2d");chart=new Chart(ctx).Pie([{value:yes,color:"#468847"},{value:no,color:"#B94A48"},{value:abstentions,color:"#F89406"},{value:notVoted,color:"#3A87AD"},{value:invalid,color:"#999999"}]);$("#resultOfTheVoteList").html('<li><span class="badge badge-success">'+yes+"</span> ja</li>"+'<li><span class="badge badge-important">'+no+"</span> nein</li>"+'<li><span class="badge badge-warning">'+abstentions+"</span> enthalten</li>"+'<li><span class="badge badge-info">'+notVoted+"</span> nicht abgestimmt</li>"+'<li><span class="badge">'+invalid+"</span> ungültig</li>"+"<li><strong>"+sum+"</strong> insgesamt</li>").fadeIn()};this.compareRevisions=function(firstRevision,secondRevision){var dmp=new diff_match_patch,firstText="",secondText="",firstRevisionTitle="ohne Titel",secondRevisionTitle="ohne Titel",firstRevisionAnnounced="ohne Datum",secondRevisionAnnounced="ohne Datum",firstRevisionID,secondRevisionID,d,comparisionOutput;if(firstRevision!==-1){firstRevisionID=that.createRevisionID(that.meta.revisions[firstRevision]);firstText=that.fetchOrCache(firstRevisionID,that.repoDir+"/out/"+that.prefix+firstRevisionID+".txt","text",false);firstRevisionTitle=that.meta.revisions[firstRevision].title;firstRevisionAnnounced=$.datepicker.formatDate(that.dateFormat,new Date(that.meta.revisions[firstRevision].announced))}if(secondRevision!==-1){secondRevisionID=that.createRevisionID(that.meta.revisions[secondRevision]);secondText=that.fetchOrCache(secondRevisionID,that.repoDir+"/out/"+that.prefix+secondRevisionID+".txt","text",false);secondRevisionTitle=that.meta.revisions[secondRevision].title;secondRevisionAnnounced=$.datepicker.formatDate(that.dateFormat,new Date(that.meta.revisions[secondRevision].announced))}dmp.Diff_Timeout=1;dmp.Diff_EditCost=4;d=dmp.diff_main(firstText,secondText);comparisionOutput=dmp.diff_prettyHtml(d);$("#compareModalLabel").html('Fassung &bdquo;<span class="highlightfirstrevision">'+firstRevisionTitle+"</span>&rdquo; ("+firstRevisionAnnounced+') verglichen mit Fassung &bdquo;<span class="highlightsecondrevision">'+secondRevisionTitle+"</span>&rdquo; ("+secondRevisionAnnounced+")");$("#compareModal .modal-body").html(comparisionOutput);$("#compareModal").modal()};this.createRevisionID=function(revision){return revision.id+"_"+revision.announced};this.fetchOrCache=function(key,uri,type,async){var value;if(localStorage){value=localStorage.getItem(key);if(!value){$.ajax({url:uri,dataType:type,async:async}).done(function(response){value=response;if(type==="json"){response=JSON.stringify(response)}localStorage.setItem(key,response)})}else if(type==="json"){value=JSON.parse(value)}}else{$.ajax({url:uri,dataType:type,async:async}).done(function(response){return response})}return value};this.collectMetaData=function(revision){var collectedMetaData=[],year,passed,date,announced,effectiveSince,articles,signedOffBy,sources,votes;if(revision.passed){passed=new Date(revision.passed);year=$.datepicker.formatDate("yy",passed);collectedMetaData.push({key:"Verabschiedet",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,passed)+"</a>"})}if(revision.date){date=new Date(revision.date);year=$.datepicker.formatDate("yy",date);collectedMetaData.push({key:"Gesetz vom",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,date)+"</a>"})}if(revision.announced){announced=new Date(revision.announced);year=$.datepicker.formatDate("yy",announced);collectedMetaData.push({key:"Angekündigt",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,announced)+"</a>"})}if(revision.effectiveSince){effectiveSince=new Date(revision.effectiveSince);year=$.datepicker.formatDate("yy",effectiveSince);collectedMetaData.push({key:"Inkraftgetreten am",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,effectiveSince)+"</a>"})}if(revision.articles){articles=[];if(revision.articles.created){articles.push("Artikel "+revision.articles.created.join(", ")+" hinzugefügt")}if(revision.articles.updated){articles.push("Artikel "+revision.articles.updated.join(", ")+" verändert")}if(revision.articles.deleted){articles.push("Artikel "+revision.articles.deleted.join(", ")+" entfernt")}collectedMetaData.push({key:"Änderungen",value:'<a href="javascript:docpatch.compareRevisions('+that.previousRevisionID+", "+revision.id+')" title="">'+articles.join("; ")+"</a>"})}if(revision.signedOffBy){signedOffBy=[];$.each(revision.signedOffBy,function(){signedOffBy.push((this.uri?'<a href="'+this.uri+'" title="'+this.uri+'">'+this.name+"</a>":this.name)+" ("+this.role+")")});collectedMetaData.push({key:"Unterschreiber",value:signedOffBy.join(", ")})}if(revision.sources){sources=[];$.each(revision.sources,function(){sources.push(this.title+", Seite "+this.pages)});collectedMetaData.push({key:"Quellen",value:sources.join(", ")})}if(revision.legislativeSession){collectedMetaData.push({key:'<a href="http://de.wikipedia.org/wiki/Deutscher_Bundestag" title="Deutscher Bundestag (Wikipedia)">Legislaturperiode</a>',value:'<a href="'+revision.legislativeSession.uri+'" title="'+revision.legislativeSession.id+'. Bundestag (Wikipedia)">'+revision.legislativeSession.id+". Bundestag</a>"})}if(revision.votes){votes=[];if(revision.votes.yes!==undefined){votes.push(revision.votes.yes+" Ja-Stimme"+(revision.votes.yes!==1?"n":""))}if(revision.votes.no!==undefined){votes.push(revision.votes.no+" Nein-Stimme"+(revision.votes.no!==1?"n":""))}if(revision.votes.abstentions!==undefined){votes.push(revision.votes.abstentions+" Enthaltung"+(revision.votes.abstentions!==1?"en":""))}if(revision.votes.notVoted!==undefined){votes.push(revision.votes.notVoted+" nicht abgestimmt")}if(revision.votes.invalid!==undefined){votes.push(revision.votes.invalid+" ungültig")}collectedMetaData.push({key:"Abstimmung",value:votes.join(", ")})}if(revision.initiativeOf){collectedMetaData.push({key:"Initiative von",value:revision.initiativeOf})}that.previousRevisionID=revision.id;return collectedMetaData};this.formatMeta=function(revision){var formatted="<table>",collectedMetaData=that.collectMetaData(revision);$.each(collectedMetaData,function(){formatted+="<tr><th>"+this.key+":</th><td>"+this.value+"</td></tr>"});formatted+="</table>";return formatted};this.drawActorsTable=function(){var actors={},entities=[],i;if(!that.actorsTableDrawn){that.actorsTableDrawn=0}if(that.actorsTableDrawn===1){return}$.each(that.meta.revisions,function(){if(this.signedOffBy){$.each(this.signedOffBy,function(){if(actors[this.uri]){actors[this.uri].number+=1;actors[this.uri].roles.push(this.role)}else{actors[this.uri]={};actors[this.uri].name=this.name;actors[this.uri].roles=[this.role];actors[this.uri].number=1;actors[this.uri].uri=this.uri}})}});for(i in actors){var roles=_.uniq(actors[i].roles);entities.push(['<a href="'+actors[i].uri+'" title="'+actors[i].uri+'">'+actors[i].name+"</a>",roles.join(", "),actors[i].number])}entities.slice(-1);$("#actorsTable").dataTable({aaData:entities,aoColumns:[{sTitle:"Name"},{sTitle:"Rollen"},{sTitle:"Unterschriften",sClass:"right"}]});that.actorsTableDrawn=1};this.drawArticlesTable=function(){var articles={},entities=[];if(!that.articlesTableDrawn){that.articlesTableDrawn=0}if(that.articlesTableDrawn===1){return}$.each(that.meta.revisions,function(){var version=this.id+1;if(this.articles){$.each(this.articles,function(key,value){$.each(value,function(){if(!articles[this]){articles[this]={};articles[this].numberOfChanges=0;articles[this].history={}}articles[this].numberOfChanges+=1;switch(key){case"created":articles[this].history.created=version;break;case"updated":if(!articles[this].history.updated){articles[this].history.updated=[]}articles[this].history.updated.push(version);break;case"deleted":articles[this].history.deleted=version;break}})})}});$.each(articles,function(key,value){var history=[];if(value.history.created){history.push("hinzugefügt in Fassung "+value.history.created)}if(value.history.updated){if(value.history.updated.length===1){history.push("geändert in Fassung "+value.history.updated.join(", "))}else{history.push("geändert in Fassungen "+value.history.updated.join(", "))}}if(value.history.deleted){history.push("aufgehoben in Fassung "+value.history.deleted)}entities.push([key,value.numberOfChanges,history.join(", ")])});$("#articlesTable").dataTable({aaData:entities,aoColumns:[{sTitle:"Artikelnummer"},{sTitle:"Anzahl Änderungen",sClass:"right"},{sTitle:"Historie"}]});that.articlesTableDrawn=1};this.drawWordCloud=function(){var fill=d3.scale.category20(),words=[],lastRevisionID=that.createRevisionID(latest),blackList,progress=0,max=200,wordList={},isBlack={},match,word,regExp=XRegExp("[\\p{L}\\d\\-]*\\p{L}{2,}[\\p{L}\\d\\-]*","igm"),maxCount=0,cloudWidth=979,cloudHeight=600;if(!that.wordCloudDrawn){that.wordCloudDrawn=0}if(that.wordCloudDrawn===1){return}var text=that.fetchOrCache(lastRevisionID,that.repoDir+"/out/"+that.prefix+lastRevisionID+".txt","text",false);blackList=that.fetchOrCache("germanST","Kickstrap/extras/blacklist/germanST.txt","text",false).split("\n");_.each(blackList,function(w){isBlack[w]=true});while(match=regExp.exec(text)){word=match[0].toLowerCase();if(!(word in isBlack)&&!(word.length>=1&&/^x{0,3}i?v?i{0,3}$/i.exec(word))){if(word in wordList){wordList[word]+=1}else{wordList[word]=1}}}words=_.sortBy(_.pairs(wordList),function(p){return-p[1]});var m=3;for(max=0;max<words.length;max++){if(words[max][1]<m){break}}console.log(max);words=words.slice(0,max-1);maxCount=words[0][1];$("#wordCloudLoading progress").attr("value",0).attr("max",max);$("#wordCloudLoading span").html(progress+"/"+max);d3.layout.cloud().size([cloudWidth,cloudHeight]).timeInterval(10).words(_.map(words,function(d){return{text:d[0],size:10+d[1]/maxCount*90}})).rotate(function(){return~~(Math.random()*2)*90}).font("Helvetica Neue").fontSize(function(d){return d.size}).padding(1).on("word",function(){progress+=1;$("#wordCloudLoading progress").attr("value",progress);$("#wordCloudLoading span").html(progress+"/"+max)}).on("end",draw).start();that.wordCloudDrawn=1;function draw(words){d3.select("#wordCloudImage").insert("svg").attr("width",cloudWidth).attr("height",cloudHeight).append("g").attr("transform","translate(150,150)").selectAll("text").data(words).enter().append("text").style("font-size",function(d){return d.size+"px"}).style("font-family","Helvetica Neue").style("fill",function(d,i){return fill(i)}).attr("text-anchor","middle").attr("transform",function(d){return"translate("+[d.x,d.y]+")rotate("+d.rotate+")"}).text(function(d){return d.text});$("#wordCloudLoading").fadeOut()}};this.meta=this.fetchOrCache("meta",this.repoDir+"/etc/meta.json","json",false);$.each(this.meta.revisions.reverse(),function(){$("#revision, #firstrevision, #secondrevision, #revisionStats").append('<option value="'+this.id+'">'+(this.id+1)+". vom "+$.datepicker.formatDate(that.dateFormat,new Date(this.announced))+": "+this.title+"</option>")});this.meta.revisions.reverse();$.each(this.formats,function(){$("#format").append('<option value="'+this.ext+'" title="'+this.ext+'">'+this.title+"</option>")});$('#format option[value="pdf"]').attr("selected","selected");$("#download").attr("href",this.repoDir+"/out/"+this.prefix+this.createRevisionID(this.meta.revisions[Number($("#revision").val())])+"."+$("#format").val());$("#revision, #format").change(function(){var revisionID=that.createRevisionID(that.meta.revisions[Number($("#revision").val())]);$("#download").attr("href",that.repoDir+"/out/"+that.prefix+revisionID+"."+$("#format").val())});var latest=this.meta.revisions.slice(-1)[0];$("#latest").attr("href",this.repoDir+"/out/"+this.prefix+this.createRevisionID(latest)+".pdf");$("#latest").attr("title",latest.id+1+'. Fassung "'+latest.title+'" vom '+$.datepicker.formatDate(this.dateFormat,new Date(latest.announced))+" im PDF-Format herunterladen");var timelineData={timeline:{headline:this.meta.title,type:"default",text:this.meta.subject,startDate:"1949,5,23",date:[]}};$.each(this.meta.revisions,function(){var announced=new Date(this.announced);timelineData.timeline.date.push({startDate:$.datepicker.formatDate("yy,m,d",announced),endDate:$.datepicker.formatDate("yy,m,d",announced),headline:this.title,text:that.formatMeta(this),asset:{media:"",credit:"",caption:""}})});createStoryJS({type:"timeline",width:"100%",height:"600",source:timelineData,lang:"de",css:"Kickstrap/apps/timelinejs/css/timeline.css",js:"Kickstrap/apps/timelinejs/js/timeline-min.js"});$("#comparerevisions").click(function(){var firstRevision=Number($("#firstrevision").val()),secondRevision=Number($("#secondrevision").val());that.compareRevisions(firstRevision,secondRevision)});$('a[data-toggle="tab"]').on("shown",function(e){switch(e.target.href.split("#")[1]){case"legislativeSessions":that.drawChangesPerPeriod();break;case"years":that.drawChangesPerYear();break;case"actors":that.drawActorsTable();break;case"revisions":that.drawResultOfTheVote();break;case"articles":that.drawArticlesTable();break;case"wordcloud":that.drawWordCloud();break}});$("#revisionStats").change(function(){that.drawResultOfTheVote()});this.numberOfChanges=this.meta.revisions.length-1;$("#numberOfChanges").html(this.numberOfChanges);this.age=this.calculateAge(this.meta.revisions[0].announced);$("#age").html(this.age);this.numberOfLegislativeSessions=latest.legislativeSession.id;$("#numberOfLegislativeSessions").html(this.numberOfLegislativeSessions);this.changesPerLegislativeSessions=this.numberOfChanges/this.numberOfLegislativeSessions;$("#numberOfChangesPerLegislativeSessions").html(Number(this.changesPerLegislativeSessions.toFixed(2))).attr("title",this.changesPerLegislativeSessions);this.changesPerYear=this.numberOfChanges/this.age;$("#numberOfChangesPerYear").html(Number(this.changesPerYear.toFixed(2))).attr("title",this.changesPerYear)};