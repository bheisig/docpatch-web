var DocPatch={};DocPatch.prefix="brd_grundgesetz_",DocPatch.repoDir="grundgesetz-dev",DocPatch.dateFormat="dd.mm.yy",DocPatch.meta={},DocPatch.formats=[{title:"DocBook",ext:"db"},{title:"eBook (EPUB)",ext:"epub"},{title:"HTML",ext:"html"},{title:"JSON",ext:"json"},{title:"Klartext (txt)",ext:"txt"},{title:"LaTeX",ext:"tex"},{title:"Man Page",ext:"gz"},{title:"Markdown",ext:"md"},{title:"Mediawiki",ext:"wiki"},{title:"Open Document",ext:"xml"},{title:"Open Document Format (ODT)",ext:"odt"},{title:"org mode (Emacs)",ext:"org"},{title:"PDF",ext:"pdf"},{title:"RST",ext:"text"},{title:"RTF",ext:"rtf"},{title:"Textile",ext:"textile"}],DocPatch.previousRevisionID=0,DocPatch.calculateAge=function(dateString){var today=new Date,birthDate=new Date(dateString),age=today.getFullYear()-birthDate.getFullYear(),m=today.getMonth()-birthDate.getMonth();return(0>m||0===m&&today.getDate()<birthDate.getDate())&&age--,age},DocPatch.drawChangesPerYear=function(){var range=_.range(Number($.datepicker.formatDate("yy",new Date(_.first(DocPatch.meta.revisions).announced))),Number($.datepicker.formatDate("yy",new Date(_.last(DocPatch.meta.revisions).announced)))+1),changesPerYear={};$.each(range,function(){changesPerYear[this.valueOf()]=0}),$.each(DocPatch.meta.revisions,function(){var year=Number($.datepicker.formatDate("yy",new Date(this.announced)));changesPerYear[year]++});var data={labels:range,datasets:[{data:$.map(changesPerYear,function(value){return value})}]},options={},ctx=$("#changesPerYear").get(0).getContext("2d");new Chart(ctx).Bar(data,options)},DocPatch.drawChangesPerPeriod=function(){var range=_.range(Number(DocPatch.meta.revisions[1].legislativeSession.id),Number(_.last(DocPatch.meta.revisions).legislativeSession.id)+1),changesPerPeriod={};$.each(range,function(){changesPerPeriod[this.valueOf()]=0}),$.each(DocPatch.meta.revisions,function(){if(this.legislativeSession){var year=Number(this.legislativeSession.id);changesPerPeriod[year]++}});var data={labels:range,datasets:[{data:$.map(changesPerPeriod,function(value){return value})}]},options={},ctx=$("#changesPerPeriod").get(0).getContext("2d");new Chart(ctx).Bar(data,options)},DocPatch.compareRevisions=function(firstRevision,secondRevision){var dmp=new diff_match_patch,firstText="",secondText="",firstRevisionTitle="ohne Titel",secondRevisionTitle="ohne Titel",firstRevisionAnnounced="ohne Datum",secondRevisionAnnounced="ohne Datum";if("-1"!=firstRevision){var firstRevisionID=DocPatch.createRevisionID(DocPatch.meta.revisions[firstRevision]);firstText=DocPatch.fetchOrCache(firstRevisionID,DocPatch.repoDir+"/out/"+DocPatch.prefix+firstRevisionID+".txt","text",!1),firstRevisionTitle=DocPatch.meta.revisions[firstRevision].title,firstRevisionAnnounced=$.datepicker.formatDate(DocPatch.dateFormat,new Date(DocPatch.meta.revisions[firstRevision].announced))}if("-1"!=secondRevision){var secondRevisionID=DocPatch.createRevisionID(DocPatch.meta.revisions[secondRevision]);secondText=DocPatch.fetchOrCache(secondRevisionID,DocPatch.repoDir+"/out/"+DocPatch.prefix+secondRevisionID+".txt","text",!1),secondRevisionTitle=DocPatch.meta.revisions[secondRevision].title,secondRevisionAnnounced=$.datepicker.formatDate(DocPatch.dateFormat,new Date(DocPatch.meta.revisions[secondRevision].announced))}dmp.Diff_Timeout=1,dmp.Diff_EditCost=4;var d=dmp.diff_main(firstText,secondText),comparisionOutput=dmp.diff_prettyHtml(d);$("#compareModalLabel").html('Fassung &bdquo;<span class="highlightfirstrevision">'+firstRevisionTitle+"</span>&rdquo; ("+firstRevisionAnnounced+') verglichen mit Fassung &bdquo;<span class="highlightsecondrevision">'+secondRevisionTitle+"</span>&rdquo; ("+secondRevisionAnnounced+")"),$("#compareModal .modal-body").html(comparisionOutput),$("#compareModal").modal()},DocPatch.createRevisionID=function(revision){return revision.id+"_"+revision.announced},DocPatch.fetchOrCache=function(key,uri,type,async){if(localStorage){var value=localStorage.getItem(key);return value?"json"==type&&(value=JSON.parse(value)):$.ajax({url:uri,dataType:type,async:async}).done(function(response){value=response,"json"==type&&(response=JSON.stringify(response)),localStorage.setItem(key,response)}),value}$.ajax({url:uri,dataType:type,async:async}).done(function(response){return response})},DocPatch.collectMetaData=function(revision){var year,collectedMetaData=[];if(revision.passed){var passed=new Date(revision.passed);year=$.datepicker.formatDate("yy",passed),collectedMetaData.push({key:"Verabschiedet",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(DocPatch.dateFormat,passed)+"</a>"})}if(revision.date){var date=new Date(revision.date);year=$.datepicker.formatDate("yy",date),collectedMetaData.push({key:"Gesetz vom",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(DocPatch.dateFormat,date)+"</a>"})}if(revision.announced){var announced=new Date(revision.announced);year=$.datepicker.formatDate("yy",announced),collectedMetaData.push({key:"Angekündigt",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(DocPatch.dateFormat,announced)+"</a>"})}if(revision.effectiveSince){var effectiveSince=new Date(revision.effectiveSince);year=$.datepicker.formatDate("yy",effectiveSince),collectedMetaData.push({key:"Inkraftgetreten am",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(DocPatch.dateFormat,effectiveSince)+"</a>"})}if(revision.articles){var articles=[];revision.articles.created&&articles.push("Artikel "+revision.articles.created.join(", ")+" hinzugefügt"),revision.articles.updated&&articles.push("Artikel "+revision.articles.updated.join(", ")+" verändert"),revision.articles.deleted&&articles.push("Artikel "+revision.articles.deleted.join(", ")+" entfernt"),collectedMetaData.push({key:"Änderungen",value:"<a href=\"javascript:DocPatch.compareRevisions('"+DocPatch.previousRevisionID+"', '"+revision.id+'\')" title="">'+articles.join("; ")+"</a>"})}if(revision.signedOffBy){var signedOffBy=[];$.each(revision.signedOffBy,function(){signedOffBy.push((this.uri?'<a href="'+this.uri+'" title="'+this.uri+'">'+this.name+"</a>":this.name)+" ("+this.role+")")}),collectedMetaData.push({key:"Unterschreiber",value:signedOffBy.join(", ")})}if(revision.sources){var sources=[];$.each(revision.sources,function(){sources.push(this.title+", Seite "+this.pages)}),collectedMetaData.push({key:"Quellen",value:sources.join(", ")})}if(revision.legislativeSession&&collectedMetaData.push({key:'<a href="http://de.wikipedia.org/wiki/Deutscher_Bundestag" title="Deutscher Bundestag (Wikipedia)">Legislaturperiode</a>',value:'<a href="'+revision.legislativeSession.uri+'" title="'+revision.legislativeSession.id+'. Bundestag (Wikipedia)">'+revision.legislativeSession.id+". Bundestag</a>"}),revision.votes){var votes=[];revision.votes.yes&&votes.push(revision.votes.yes+" Ja-Stimme"+(1!=revision.votes.yes?"n":"")),revision.votes.no&&votes.push(revision.votes.no+" Nein-Stimme"+(1!=revision.votes.no?"n":"")),revision.votes.abstentions&&votes.push(revision.votes.abstentions+" Enthaltung"+(1!=revision.votes.abstentions?"en":"")),collectedMetaData.push({key:"Abstimmung",value:votes.join(", ")})}return revision.initiativeOf&&collectedMetaData.push({key:"Initiative von",value:revision.initiativeOf}),DocPatch.previousRevisionID=revision.id,collectedMetaData},DocPatch.formatMeta=function(revision){var formatted;formatted="<table>";var collectedMetaData=DocPatch.collectMetaData(revision);return $.each(collectedMetaData,function(){formatted+="<tr><th>"+this.key+":</th><td>"+this.value+"</td></tr>"}),formatted+="</table>"},DocPatch.drawActorsTable=function(){if(DocPatch.drawActorsTable||(DocPatch.drawActorsTable=0),1!==DocPatch.drawActorsTable){var actors={};$.each(DocPatch.meta.revisions,function(){this.signedOffBy&&$.each(this.signedOffBy,function(){actors[this.uri]?(actors[this.uri].number++,actors[this.uri].roles.push(this.role)):(actors[this.uri]={},actors[this.uri].name=this.name,actors[this.uri].roles=[this.role],actors[this.uri].number=1,actors[this.uri].uri=this.uri)})});var entities=[];for(var i in actors){var roles=_.uniq(actors[i].roles);entities.push(['<a href="'+actors[i].uri+'" title="'+actors[i].uri+'">'+actors[i].name+"</a>",roles.join(", "),actors[i].number])}entities.slice(-1),$("#actorsTable").dataTable({aaData:entities,aoColumns:[{sTitle:"Name"},{sTitle:"Rollen"},{sTitle:"Unterschriften",sClass:"right"}]}),DocPatch.drawActorsTable=1}},DocPatch.drawArticlesTable=function(){if(DocPatch.drawArticlesTable||(DocPatch.drawArticlesTable=0),1!==DocPatch.drawArticlesTable){var articles={};$.each(DocPatch.meta.revisions,function(){var version=this.id+1;this.articles&&$.each(this.articles,function(key,value){$.each(value,function(){switch(articles[this]||(articles[this]={},articles[this].numberOfChanges=0,articles[this].history={}),articles[this].numberOfChanges++,key){case"created":articles[this].history.created=version;break;case"updated":articles[this].history.updated||(articles[this].history.updated=[]),articles[this].history.updated.push(version);break;case"deleted":articles[this].history.deleted=version}})})});var entities=[];$.each(articles,function(key,value){var history=[];value.history.created&&history.push("hinzugefügt in Fassung "+value.history.created),value.history.updated&&(1===value.history.updated.length?history.push("geändert in Fassung "+value.history.updated.join(", ")):history.push("geändert in Fassungen "+value.history.updated.join(", "))),value.history.deleted&&history.push("aufgehoben in Fassung "+value.history.deleted),entities.push([key,value.numberOfChanges,history.join(", ")])}),$("#articlesTable").dataTable({aaData:entities,aoColumns:[{sTitle:"Artikelnummer"},{sTitle:"Anzahl Änderungen",sClass:"right"},{sTitle:"Historie"}]}),DocPatch.drawArticlesTable=1}};