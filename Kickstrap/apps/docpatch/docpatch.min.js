var DocPatch=function(options){"use strict";this.prefix=options.prefix,this.repoDir=options.repoDir,this.dateFormat=options.dateFormat,this.meta={},this.formats=[{title:"DocBook",ext:"db"},{title:"eBook (EPUB)",ext:"epub"},{title:"HTML",ext:"html"},{title:"JSON",ext:"json"},{title:"Klartext (txt)",ext:"txt"},{title:"LaTeX",ext:"tex"},{title:"Man Page",ext:"gz"},{title:"Markdown",ext:"md"},{title:"Mediawiki",ext:"wiki"},{title:"Open Document",ext:"xml"},{title:"Open Document Format (ODT)",ext:"odt"},{title:"org mode (Emacs)",ext:"org"},{title:"PDF",ext:"pdf"},{title:"RST",ext:"text"},{title:"RTF",ext:"rtf"},{title:"Textile",ext:"textile"}],this.previousRevisionID=0;var that=this;this.calculateAge=function(dateString){var today=new Date,birthDate=new Date(dateString),age=today.getFullYear()-birthDate.getFullYear(),m=today.getMonth()-birthDate.getMonth();return(0>m||0===m&&today.getDate()<birthDate.getDate())&&(age-=1),age},this.drawChangesPerYear=function(){var range,chart,changes={},ctx=$("#changesPerYear").get(0).getContext("2d");range=_.range(Number($.datepicker.formatDate("yy",new Date(_.first(that.meta.revisions).announced))),Number($.datepicker.formatDate("yy",new Date(_.last(that.meta.revisions).announced)))+1),$.each(range,function(){changes[this.valueOf()]=0}),$.each(that.meta.revisions,function(){var year=Number($.datepicker.formatDate("yy",new Date(this.announced)));changes[year]+=1}),chart=new Chart(ctx).Bar({labels:range,datasets:[{data:$.map(changes,function(key){return key})}]})},this.drawChangesPerPeriod=function(){var range,chart,changes={},ctx=$("#changesPerPeriod").get(0).getContext("2d");range=_.range(Number(that.meta.revisions[1].legislativeSession.id),Number(_.last(that.meta.revisions).legislativeSession.id)+1),$.each(range,function(){changes[this.valueOf()]=0}),$.each(that.meta.revisions,function(){if(this.legislativeSession){var year=Number(this.legislativeSession.id);changes[year]+=1}}),chart=new Chart(ctx).Bar({labels:range,datasets:[{data:$.map(changes,function(key){return key})}]})},this.drawResultOfTheVote=function(){var ctx,chart,revision=that.meta.revisions[Number($("#revisionStats").val())],yes=revision.votes&&revision.votes.yes||0,no=revision.votes&&revision.votes.no||0,abstentions=revision.votes&&revision.votes.abstentions||0,notVoted=revision.votes&&revision.votes.notVoted||0,invalid=revision.votes&&revision.votes.invalid||0,sum=yes+no+abstentions+notVoted+invalid;return $("#resultOfTheVoteAlert").removeClass("in"),$("#resultOfTheVote").hide(),$("#resultOfTheVoteList").hide(),revision.votes?(ctx=$("#resultOfTheVote").fadeIn().get(0).getContext("2d"),chart=new Chart(ctx).Pie([{value:yes,color:"#468847"},{value:no,color:"#B94A48"},{value:abstentions,color:"#F89406"},{value:notVoted,color:"#3A87AD"},{value:invalid,color:"#999999"}]),$("#resultOfTheVoteList").html('<li><span class="badge badge-success">'+yes+"</span> ja</li>"+'<li><span class="badge badge-important">'+no+"</span> nein</li>"+'<li><span class="badge badge-warning">'+abstentions+"</span> enthalten</li>"+'<li><span class="badge badge-info">'+notVoted+"</span> nicht abgestimmt</li>"+'<li><span class="badge">'+invalid+"</span> ungültig</li>"+"<li><strong>"+sum+"</strong> insgesamt</li>").fadeIn(),void 0):($("#resultOfTheVoteAlert").addClass("in"),void 0)},this.compareRevisions=function(firstRevision,secondRevision){var firstRevisionID,secondRevisionID,d,comparisionOutput,dmp=new diff_match_patch,firstText="",secondText="",firstRevisionTitle="ohne Titel",secondRevisionTitle="ohne Titel",firstRevisionAnnounced="ohne Datum",secondRevisionAnnounced="ohne Datum";-1!==firstRevision&&(firstRevisionID=that.createRevisionID(that.meta.revisions[firstRevision]),firstText=that.fetchOrCache(firstRevisionID,that.repoDir+"/out/"+that.prefix+firstRevisionID+".txt","text",!1),firstRevisionTitle=that.meta.revisions[firstRevision].title,firstRevisionAnnounced=$.datepicker.formatDate(that.dateFormat,new Date(that.meta.revisions[firstRevision].announced))),-1!==secondRevision&&(secondRevisionID=that.createRevisionID(that.meta.revisions[secondRevision]),secondText=that.fetchOrCache(secondRevisionID,that.repoDir+"/out/"+that.prefix+secondRevisionID+".txt","text",!1),secondRevisionTitle=that.meta.revisions[secondRevision].title,secondRevisionAnnounced=$.datepicker.formatDate(that.dateFormat,new Date(that.meta.revisions[secondRevision].announced))),dmp.Diff_Timeout=1,dmp.Diff_EditCost=4,d=dmp.diff_main(firstText,secondText),comparisionOutput=dmp.diff_prettyHtml(d),$("#compareModalLabel").html('Fassung &bdquo;<span class="highlightfirstrevision">'+firstRevisionTitle+"</span>&rdquo; ("+firstRevisionAnnounced+') verglichen mit Fassung &bdquo;<span class="highlightsecondrevision">'+secondRevisionTitle+"</span>&rdquo; ("+secondRevisionAnnounced+")"),$("#compareModal .modal-body").html(comparisionOutput),$("#compareModal").modal()},this.createRevisionID=function(revision){return revision.id+"_"+revision.announced},this.fetchOrCache=function(key,uri,type,async){var value;return localStorage?(value=localStorage.getItem(key),value?"json"===type&&(value=JSON.parse(value)):$.ajax({url:uri,dataType:type,async:async}).done(function(response){value=response,"json"===type&&(response=JSON.stringify(response)),localStorage.setItem(key,response)})):$.ajax({url:uri,dataType:type,async:async}).done(function(response){return response}),value},this.collectMetaData=function(revision){var year,passed,date,announced,effectiveSince,articles,signedOffBy,sources,votes,collectedMetaData=[];return revision.passed&&(passed=new Date(revision.passed),year=$.datepicker.formatDate("yy",passed),collectedMetaData.push({key:"Verabschiedet",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,passed)+"</a>"})),revision.date&&(date=new Date(revision.date),year=$.datepicker.formatDate("yy",date),collectedMetaData.push({key:"Gesetz vom",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,date)+"</a>"})),revision.announced&&(announced=new Date(revision.announced),year=$.datepicker.formatDate("yy",announced),collectedMetaData.push({key:"Angekündigt",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,announced)+"</a>"})),revision.effectiveSince&&(effectiveSince=new Date(revision.effectiveSince),year=$.datepicker.formatDate("yy",effectiveSince),collectedMetaData.push({key:"Inkraftgetreten am",value:'<a href="http://de.wikipedia.org/wiki/'+year+'" title="'+year+' (Wikipedia)">'+$.datepicker.formatDate(that.dateFormat,effectiveSince)+"</a>"})),revision.articles&&(articles=[],revision.articles.created&&articles.push("Artikel "+revision.articles.created.join(", ")+" hinzugefügt"),revision.articles.updated&&articles.push("Artikel "+revision.articles.updated.join(", ")+" verändert"),revision.articles.deleted&&articles.push("Artikel "+revision.articles.deleted.join(", ")+" entfernt"),collectedMetaData.push({key:"Änderungen",value:'<a href="javascript:docpatch.compareRevisions('+that.previousRevisionID+", "+revision.id+')" title="">'+articles.join("; ")+"</a>"})),revision.signedOffBy&&(signedOffBy=[],$.each(revision.signedOffBy,function(){signedOffBy.push((this.uri?'<a href="'+this.uri+'" title="'+this.uri+'">'+this.name+"</a>":this.name)+" ("+this.role+")")}),collectedMetaData.push({key:"Unterschreiber",value:signedOffBy.join(", ")})),revision.sources&&(sources=[],$.each(revision.sources,function(){sources.push(this.title+", Seite "+this.pages)}),collectedMetaData.push({key:"Quellen",value:sources.join(", ")})),revision.legislativeSession&&collectedMetaData.push({key:'<a href="http://de.wikipedia.org/wiki/Deutscher_Bundestag" title="Deutscher Bundestag (Wikipedia)">Legislaturperiode</a>',value:'<a href="'+revision.legislativeSession.uri+'" title="'+revision.legislativeSession.id+'. Bundestag (Wikipedia)">'+revision.legislativeSession.id+". Bundestag</a>"}),revision.votes&&(votes=[],void 0!==revision.votes.yes&&votes.push(revision.votes.yes+" Ja-Stimme"+(1!==revision.votes.yes?"n":"")),void 0!==revision.votes.no&&votes.push(revision.votes.no+" Nein-Stimme"+(1!==revision.votes.no?"n":"")),void 0!==revision.votes.abstentions&&votes.push(revision.votes.abstentions+" Enthaltung"+(1!==revision.votes.abstentions?"en":"")),void 0!==revision.votes.notVoted&&votes.push(revision.votes.notVoted+" nicht abgestimmt"),void 0!==revision.votes.invalid&&votes.push(revision.votes.invalid+" ungültig"),collectedMetaData.push({key:"Abstimmung",value:votes.join(", ")})),revision.initiativeOf&&collectedMetaData.push({key:"Initiative von",value:revision.initiativeOf}),that.previousRevisionID=revision.id,collectedMetaData},this.formatMeta=function(revision){var formatted="<table>",collectedMetaData=that.collectMetaData(revision);return $.each(collectedMetaData,function(){formatted+="<tr><th>"+this.key+":</th><td>"+this.value+"</td></tr>"}),formatted+="</table>"},this.drawActorsTable=function(){var i,actors={},entities=[];if(that.actorsTableDrawn||(that.actorsTableDrawn=0),1!==that.actorsTableDrawn){$.each(that.meta.revisions,function(){this.signedOffBy&&$.each(this.signedOffBy,function(){actors[this.uri]?(actors[this.uri].number+=1,actors[this.uri].roles.push(this.role)):(actors[this.uri]={},actors[this.uri].name=this.name,actors[this.uri].roles=[this.role],actors[this.uri].number=1,actors[this.uri].uri=this.uri)})});for(i in actors){var roles=_.uniq(actors[i].roles);entities.push(['<a href="'+actors[i].uri+'" title="'+actors[i].uri+'">'+actors[i].name+"</a>",roles.join(", "),actors[i].number])}entities.slice(-1),$("#actorsTable").dataTable({aaData:entities,aoColumns:[{sTitle:"Name"},{sTitle:"Rollen"},{sTitle:"Unterschriften",sClass:"right"}]}),that.actorsTableDrawn=1}},this.drawArticlesTable=function(){var articles={},entities=[];that.articlesTableDrawn||(that.articlesTableDrawn=0),1!==that.articlesTableDrawn&&($.each(that.meta.revisions,function(){var version=this.id+1;this.articles&&$.each(this.articles,function(key,value){$.each(value,function(){switch(articles[this]||(articles[this]={},articles[this].numberOfChanges=0,articles[this].history={}),articles[this].numberOfChanges+=1,key){case"created":articles[this].history.created=version;break;case"updated":articles[this].history.updated||(articles[this].history.updated=[]),articles[this].history.updated.push(version);break;case"deleted":articles[this].history.deleted=version}})})}),$.each(articles,function(key,value){var history=[];value.history.created&&history.push("hinzugefügt in Fassung "+value.history.created),value.history.updated&&(1===value.history.updated.length?history.push("geändert in Fassung "+value.history.updated.join(", ")):history.push("geändert in Fassungen "+value.history.updated.join(", "))),value.history.deleted&&history.push("aufgehoben in Fassung "+value.history.deleted),entities.push([key,value.numberOfChanges,history.join(", ")])}),$("#articlesTable").dataTable({aaData:entities,aoColumns:[{sTitle:"Artikelnummer"},{sTitle:"Anzahl Änderungen",sClass:"right"},{sTitle:"Historie"}]}),that.articlesTableDrawn=1)},this.drawWordCloud=function(){function draw(words){d3.select("#wordCloudImage").insert("svg").attr("width",979).attr("height",600).append("g").attr("transform","translate(150,150)").selectAll("text").data(words).enter().append("text").style("font-size",function(d){return d.size+"px"}).style("font-family","Impact").style("fill",function(d,i){return fill(i)}).attr("text-anchor","middle").attr("transform",function(d){return"translate("+[d.x,d.y]+")rotate("+d.rotate+")"}).text(function(d){return d.text}),$("#wordCloudLoading").fadeOut()}var blackList,fill=d3.scale.category20(),chosenWords=[],lastRevisionID=that.createRevisionID(latest),progress=0;that.wordCloudDrawn||(that.wordCloudDrawn=0),1!==that.wordCloudDrawn&&(blackList=["in","im","am","an","vor","auf","durch","zu","von","zum","aus","mit","ohne","zur","nach","über","unter","so","um","vom","bei","hin","für","gegen","hierauf","dort","hier","der","die","das","den","dem","des","dieser","diese","dieses","deren","dessen","denen","jeder","jede","jedes","jeden","er","sie","es","anderer","andere","anderes","anderen","und","oder","nicht","nur","sich","bestimmt","bestimmte","bestimmter","bestimmtes","ganz","ganzen","ganzes","ganzer","ist","sind","hat","haben","wird","werden","als","so","bis","je","wer","wie","was","weshalb","warum","welches","wessen","wo","wann","daß","dass","wegen","deshalb","wenn","aber","auch","weder","noch","sondern","darum","soweit","damit","wieder","dadurch","sowie","seiner","sein","seinen","seines","ihrer","ihr","ihre","ihren","einen","ein","einem","eines","eine","einer","kann","können","muss","müssen","darf","dürfen","soll","sollen","will","wollen","Artikel","Art","Absatz","Gesetz","Abs","Satz"],String.prototype.removeBlackWords=function(){var index,exp,removed=this;for(index=0;blackList.length>index;index+=1)exp=RegExp("\\b"+blackList[index]+"\\b","igm"),removed=removed.replace(exp,"");return removed},chosenWords=that.fetchOrCache(lastRevisionID,that.repoDir+"/out/"+that.prefix+lastRevisionID+".txt","text",!1).slice(0,1e4).replace(/([0-9\[\]\(\),;\.\-="]+)/gim,"").replace(/\b[:alpha:]{1,2}\b/g,"").removeBlackWords().split(" "),$("#wordCloudLoading progress").attr("value",0).attr("max",chosenWords.length),$("#wordCloudLoading span").html(progress+"/"+chosenWords.length),d3.layout.cloud().size([2342,1200]).timeInterval(10).words(chosenWords.map(function(d){return{text:d,size:10+90*Math.random()}})).rotate(function(){return 90*~~(2*Math.random())}).font("Impact").fontSize(function(d){return d.size}).on("word",function(){progress+=1,$("#wordCloudLoading progress").attr("value",progress),$("#wordCloudLoading span").html(progress+"/"+chosenWords.length)}).on("end",draw).start(),that.wordCloudDrawn=1)},this.meta=this.fetchOrCache("meta",this.repoDir+"/etc/meta.json","json",!1),$.each(this.meta.revisions.reverse(),function(){$("#revision, #firstrevision, #secondrevision, #revisionStats").append('<option value="'+this.id+'">'+(this.id+1)+". vom "+$.datepicker.formatDate(that.dateFormat,new Date(this.announced))+": "+this.title+"</option>")}),this.meta.revisions.reverse(),$.each(this.formats,function(){$("#format").append('<option value="'+this.ext+'" title="'+this.ext+'">'+this.title+"</option>")}),$('#format option[value="pdf"]').attr("selected","selected"),$("#download").attr("href",this.repoDir+"/out/"+this.prefix+this.createRevisionID(this.meta.revisions[Number($("#revision").val())])+"."+$("#format").val()),$("#revision, #format").change(function(){var revisionID=that.createRevisionID(that.meta.revisions[Number($("#revision").val())]);$("#download").attr("href",that.repoDir+"/out/"+that.prefix+revisionID+"."+$("#format").val())});var latest=this.meta.revisions.slice(-1)[0];$("#latest").attr("href",this.repoDir+"/out/"+this.prefix+this.createRevisionID(latest)+".pdf"),$("#latest").attr("title",latest.id+1+'. Fassung "'+latest.title+'" vom '+$.datepicker.formatDate(this.dateFormat,new Date(latest.announced))+" im PDF-Format herunterladen");var timelineData={timeline:{headline:this.meta.title,type:"default",text:this.meta.subject,startDate:"1949,5,23",date:[]}};$.each(this.meta.revisions,function(){var announced=new Date(this.announced);timelineData.timeline.date.push({startDate:$.datepicker.formatDate("yy,m,d",announced),endDate:$.datepicker.formatDate("yy,m,d",announced),headline:this.title,text:that.formatMeta(this),asset:{media:"",credit:"",caption:""}})}),createStoryJS({type:"timeline",width:"100%",height:"600",source:timelineData,lang:"de",css:"Kickstrap/apps/timelinejs/css/timeline.css",js:"Kickstrap/apps/timelinejs/js/timeline-min.js"}),$("#comparerevisions").click(function(){var firstRevision=Number($("#firstrevision").val()),secondRevision=Number($("#secondrevision").val());that.compareRevisions(firstRevision,secondRevision)}),$('a[data-toggle="tab"]').on("shown",function(e){switch(e.target.href.split("#")[1]){case"legislativeSessions":that.drawChangesPerPeriod();break;case"years":that.drawChangesPerYear();break;case"actors":that.drawActorsTable();break;case"revisions":that.drawResultOfTheVote();break;case"articles":that.drawArticlesTable();break;case"wordcloud":that.drawWordCloud()}}),$("#revisionStats").change(function(){that.drawResultOfTheVote()}),this.numberOfChanges=this.meta.revisions.length-1,$("#numberOfChanges").html(this.numberOfChanges),this.age=this.calculateAge(this.meta.revisions[0].announced),$("#age").html(this.age),this.numberOfLegislativeSessions=latest.legislativeSession.id,$("#numberOfLegislativeSessions").html(this.numberOfLegislativeSessions),this.changesPerLegislativeSessions=this.numberOfChanges/this.numberOfLegislativeSessions,$("#numberOfChangesPerLegislativeSessions").html(Number(this.changesPerLegislativeSessions.toFixed(2))).attr("title",this.changesPerLegislativeSessions),this.changesPerYear=this.numberOfChanges/this.age,$("#numberOfChangesPerYear").html(Number(this.changesPerYear.toFixed(2))).attr("title",this.changesPerYear)};